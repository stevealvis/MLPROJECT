{% extends "basic.html" %}
{% load static %}

{% block head %}

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f4f6f8;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    margin: 0;
    padding: 20px 0;
  }
  
  .signup-container {
    width: 420px;
    background: #fff;
    padding: 25px;
    border-radius: 8px;
    box-shadow: 0 0 15px rgba(0,0,0,0.1);
    animation: slideInUp 0.6s ease-out;
  }

  .signup-title {
    text-align: center;
    margin-bottom: 15px;
    color: #333;
    font-size: 1.8rem;
    font-weight: 600;
  }

  .input-field {
    width: 100%;
    padding: 10px;
    margin-top: 8px;
    margin-bottom: 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
    transition: border-color 0.3s ease;
  }

  .input-field:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.25);
  }

  .input-field.valid {
    border-color: #28a745;
  }

  .input-field.invalid {
    border-color: #dc3545;
  }

  .select-field {
    width: 100%;
    padding: 10px;
    margin-top: 8px;
    margin-bottom: 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
    transition: border-color 0.3s ease;
  }

  .select-field:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.25);
  }

  .submit-btn {
    width: 100%;
    padding: 12px;
    background: #007bff;
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
    margin-top: 10px;
  }

  .submit-btn:hover {
    background: #0056b3;
  }

  .submit-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
  }

  .small {
    font-size: 13px;
    color: #666;
    margin-top: 5px;
  }

  .error {
    color: #dc3545;
    font-size: 13px;
    margin-top: 5px;
    display: none;
  }

  .error.show {
    display: block;
  }

  .alert {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    border-radius: 4px;
    padding: 12px;
    margin-bottom: 15px;
    font-size: 14px;
  }

  .password-strength-container {
    margin-top: 5px;
    padding: 8px;
    background: #f8f9fa;
    border-radius: 4px;
    border: 1px solid #dee2e6;
  }

  .strength-bar {
    height: 6px;
    background: #e9ecef;
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 5px;
  }

  .strength-fill {
    height: 100%;
    width: 0%;
    transition: all 0.3s ease;
    border-radius: 3px;
  }

  .strength-fill.weak { 
    background: #dc3545; 
    width: 25%;
  }

  .strength-fill.fair { 
    background: #ffc107; 
    width: 50%;
  }

  .strength-fill.good { 
    background: #28a745; 
    width: 75%;
  }

  .strength-fill.strong { 
    background: #20c997; 
    width: 100%;
  }

  .strength-text {
    font-size: 12px;
    color: #6c757d;
    text-align: center;
  }

  .radio-group {
    margin-top: 8px;
    margin-bottom: 12px;
  }

  .radio-group label {
    margin-right: 15px;
    font-weight: normal;
    cursor: pointer;
  }

  .form-row {
    display: flex;
    gap: 10px;
  }

  .form-col {
    flex: 1;
  }

  .field-group {
    margin-bottom: 12px;
  }

  .field-label {
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
    display: block;
  }

  @keyframes slideInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (max-width: 480px) {
    .signup-container {
      width: 95%;
      margin: 0 10px;
      padding: 20px;
    }
    
    .form-row {
      flex-direction: column;
      gap: 0;
    }
  }
</style>

{% endblock %}

{% block body %}

<div class="signup-container">
  <h2 class="signup-title">Medical Portal â€“ Doctor Sign Up</h2>

  <form id="signupForm" action='signup_doctor' method="POST">
    {% csrf_token %}
    
    {% for message in messages %}
    <div class="alert" role="alert">
      {{message}}
    </div>
    {% endfor %}

    <div class="field-group">
      <label class="field-label">Full Name</label>
      {{ form.name }}
      <div class="error" id="name-error"></div>
    </div>

    <div class="field-group">
      <label class="field-label">Username</label>
      {{ form.username }}
      <div class="error" id="username-error"></div>
    </div>

    <div class="field-group">
      <label class="field-label">Email Address</label>
      {{ form.email }}
      <div class="error" id="email-error"></div>
    </div>

    <div class="field-group">
      <label class="field-label">Date of Birth</label>
      {{ form.dob }}
      <div class="error" id="dob-error"></div>
    </div>

    <div class="field-group">
      <label class="field-label">Gender</label>
      <div class="radio-group">
        {{ form.gender }}
      </div>
      <div class="error" id="gender-error"></div>
    </div>

    <div class="field-group">
      <label class="field-label">Residential Address</label>
      {{ form.address }}
      <div class="error" id="address-error"></div>
    </div>

    <div class="field-group">
      <label class="field-label">Mobile Number</label>
      {{ form.mobile_no }}
      <div class="error" id="mobile-error"></div>
    </div>

    <div class="field-group">
      <label class="field-label">Medical Registration Number</label>
      {{ form.registration_no }}
      <div class="error" id="registration_no-error"></div>
    </div>

    <div class="field-group">
      <label class="field-label">Year of Registration</label>
      {{ form.year_of_registration }}
      <div class="error" id="year_of_registration-error"></div>
    </div>

    <div class="field-group">
      <label class="field-label">Qualification</label>
      {{ form.qualification }}
      <div class="error" id="qualification-error"></div>
    </div>

    <div class="field-group">
      <label class="field-label">State Medical Council</label>
      {{ form.State_Medical_Council }}
      <div class="error" id="State_Medical_Council-error"></div>
    </div>

    <div class="field-group">
      <label class="field-label">Specialization</label>
      {{ form.specialization }}
      <div class="error" id="specialization-error"></div>
    </div>

    <div class="field-group">
      <label class="field-label">Password</label>
      {{ form.password }}
      <div class="password-strength-container">
        <div class="strength-bar">
          <div class="strength-fill" id="strength-fill"></div>
        </div>
        <div class="strength-text">
          Password strength: <span id="strength-label">Enter password</span>
        </div>
      </div>
      <div class="small">
        Password must contain at least:
        <ul>
          <li>8 characters</li>
          <li>1 uppercase letter</li>
          <li>1 lowercase letter</li>
          <li>1 number</li>
          <li>1 special character</li>
        </ul>
      </div>
      <div class="error" id="password-error"></div>
    </div>

    <div class="field-group">
      <label class="field-label">Confirm Password</label>
      {{ form.password1 }}
      <div class="error" id="password1-error"></div>
    </div>

    <div id="error" class="error"></div>

    <button type="submit" class="submit-btn">Create Account</button>
  </form>
</div>

<!-- Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

<script>
document.getElementById("signupForm").addEventListener("submit", function(e) {
    e.preventDefault();

    const password = document.querySelector('input[name="password"]').value;
    const dob = new Date(document.querySelector('input[name="dob"]').value);
    const yor = new Date(document.querySelector('input[name="year_of_registration"]').value);
    const today = new Date();
    const error = document.getElementById("error");

    // Age validation (24+ for doctors)
    const age = today.getFullYear() - dob.getFullYear();
    if (age < 24) {
        error.textContent = "Doctor must be at least 24 years old.";
        error.classList.add('show');
        return;
    }

    // Registration year validation
    const ageAtReg = yor.getFullYear() - dob.getFullYear();
    if (ageAtReg < 24) {
        error.textContent = "You should be at least 24 years old when registering.";
        error.classList.add('show');
        return;
    }

    if (yor > today) {
        error.textContent = "Registration year cannot be in the future.";
        error.classList.add('show');
        return;
    }

    // Password validation
    const pattern = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&#]).{8,}$/;
    if (!pattern.test(password)) {
        error.textContent = "Password does not meet security requirements.";
        error.classList.add('show');
        return;
    }

    error.textContent = "";
    error.classList.remove('show');
    alert("Account created successfully!");
});

// Enhanced real-time validation for doctor form
document.addEventListener('DOMContentLoaded', function() {
    // Password strength indicator
    const password = document.querySelector('input[name="password"]');
    const strengthFill = document.getElementById('strength-fill');
    const strengthLabel = document.getElementById('strength-label');
    
    if (password && strengthFill && strengthLabel) {
        password.addEventListener('input', function() {
            const strength = calculatePasswordStrength(this.value);
            updateStrengthIndicator(strength);
        });
    }

    // Password confirmation
    const password1 = document.querySelector('input[name="password1"]');
    if (password && password1) {
        password1.addEventListener('input', function() {
            if (password.value !== this.value) {
                this.setCustomValidity('Passwords do not match');
                this.classList.add('invalid');
                this.classList.remove('valid');
            } else {
                this.setCustomValidity('');
                this.classList.add('valid');
                this.classList.remove('invalid');
            }
        });
        
        password.addEventListener('input', function() {
            if (password1.value) {
                if (password.value !== password1.value) {
                    password1.setCustomValidity('Passwords do not match');
                    password1.classList.add('invalid');
                    password1.classList.remove('valid');
                } else {
                    password1.setCustomValidity('');
                    password1.classList.add('valid');
                    password1.classList.remove('invalid');
                }
            }
        });
    }

    // Enhanced phone number validation
    const mobile = document.querySelector('input[name="mobile_no"]');
    if (mobile) {
        mobile.addEventListener('input', function() {
            let value = this.value.replace(/\D/g, '');
            if (value.length > 10) {
                value = value.substring(0, 10);
            }
            this.value = value;
            
            if (value.length === 10) {
                const validPrefix = ['6', '7', '8', '9'];
                if (validPrefix.includes(value[0])) {
                    this.classList.add('valid');
                    this.classList.remove('invalid');
                    this.setCustomValidity('');
                } else {
                    this.classList.add('invalid');
                    this.classList.remove('valid');
                    this.setCustomValidity('Mobile number must start with 6, 7, 8, or 9');
                }
            } else if (value.length > 0) {
                this.classList.add('invalid');
                this.classList.remove('valid');
                this.setCustomValidity('Mobile number must be exactly 10 digits');
            } else {
                this.classList.remove('valid', 'invalid');
                this.setCustomValidity('');
            }
        });
    }

    // Username validation
    const username = document.querySelector('input[name="username"]');
    if (username) {
        username.addEventListener('input', function() {
            const value = this.value;
            const isValid = /^[a-zA-Z0-9_]+$/.test(value) && value.length >= 3 && value.length <= 30;
            
            if (value.length === 0) {
                this.classList.remove('valid', 'invalid');
                this.setCustomValidity('');
            } else if (isValid) {
                this.classList.add('valid');
                this.classList.remove('invalid');
                this.setCustomValidity('');
            } else {
                this.classList.add('invalid');
                this.classList.remove('valid');
                if (value.length < 3) {
                    this.setCustomValidity('Username must be at least 3 characters long');
                } else if (value.length > 30) {
                    this.setCustomValidity('Username cannot be more than 30 characters long');
                } else {
                    this.setCustomValidity('Username can only contain letters, numbers, and underscores');
                }
            }
        });
    }

    // Email validation
    const email = document.querySelector('input[name="email"]');
    if (email) {
        email.addEventListener('input', function() {
            const value = this.value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (value.length === 0) {
                this.classList.remove('valid', 'invalid');
                this.setCustomValidity('');
            } else if (emailRegex.test(value)) {
                this.classList.add('valid');
                this.classList.remove('invalid');
                this.setCustomValidity('');
            } else {
                this.classList.add('invalid');
                this.classList.remove('valid');
                this.setCustomValidity('Please enter a valid email address');
            }
        });
    }

    // Name validation
    const name = document.querySelector('input[name="name"]');
    if (name) {
        name.addEventListener('input', function() {
            const value = this.value.trim();
            
            if (value.length === 0) {
                this.classList.remove('valid', 'invalid');
                this.setCustomValidity('');
            } else if (value.length >= 2) {
                this.classList.add('valid');
                this.classList.remove('invalid');
                this.setCustomValidity('');
            } else {
                this.classList.add('invalid');
                this.classList.remove('valid');
                this.setCustomValidity('Name must be at least 2 characters long');
            }
        });
    }

    // Address validation
    const address = document.querySelector('textarea[name="address"]');
    if (address) {
        address.addEventListener('input', function() {
            const value = this.value.trim();
            
            if (value.length === 0) {
                this.classList.remove('valid', 'invalid');
                this.setCustomValidity('');
            } else if (value.length >= 10) {
                this.classList.add('valid');
                this.classList.remove('invalid');
                this.setCustomValidity('');
            } else {
                this.classList.add('invalid');
                this.classList.remove('valid');
                this.setCustomValidity('Address must be at least 10 characters long');
            }
        });
    }

    // Registration number validation
    const regNo = document.querySelector('input[name="registration_no"]');
    if (regNo) {
        regNo.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
            const value = this.value;
            
            if (value.length === 0) {
                this.classList.remove('valid', 'invalid');
                this.setCustomValidity('');
            } else if (value.length >= 6 && value.length <= 20) {
                this.classList.add('valid');
                this.classList.remove('invalid');
                this.setCustomValidity('');
            } else {
                this.classList.add('invalid');
                this.classList.remove('valid');
                if (value.length < 6) {
                    this.setCustomValidity('Registration number must be at least 6 characters long');
                } else {
                    this.setCustomValidity('Registration number cannot be more than 20 characters long');
                }
            }
        });
    }

    // Qualification validation
    const qualification = document.querySelector('input[name="qualification"]');
    if (qualification) {
        qualification.addEventListener('input', function() {
            const value = this.value.trim();
            
            if (value.length === 0) {
                this.classList.remove('valid', 'invalid');
                this.setCustomValidity('');
            } else if (value.length >= 2) {
                this.classList.add('valid');
                this.classList.remove('invalid');
                this.setCustomValidity('');
            } else {
                this.classList.add('invalid');
                this.classList.remove('valid');
                this.setCustomValidity('Qualification must be at least 2 characters long');
            }
        });
    }

    // Medical Council validation
    const medicalCouncil = document.querySelector('input[name="State_Medical_Council"]');
    if (medicalCouncil) {
        medicalCouncil.addEventListener('input', function() {
            const value = this.value.trim();
            
            if (value.length === 0) {
                this.classList.remove('valid', 'invalid');
                this.setCustomValidity('');
            } else if (value.length >= 3) {
                this.classList.add('valid');
                this.classList.remove('invalid');
                this.setCustomValidity('');
            } else {
                this.classList.add('invalid');
                this.classList.remove('valid');
                this.setCustomValidity('State Medical Council name must be at least 3 characters long');
            }
        });
    }

    // DOB and Year of Registration validation
    const dob = document.querySelector('input[name="dob"]');
    const yor = document.querySelector('input[name="year_of_registration"]');
    
    if (dob && yor) {
        const validateDates = () => {
            const dobValue = new Date(dob.value);
            const yorValue = new Date(yor.value);
            
            if (dobValue && yorValue) {
                // Calculate age at registration
                const ageAtReg = yorValue.getFullYear() - dobValue.getFullYear();
                const monthDiff = yorValue.getMonth() - dobValue.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && yorValue.getDate() < dobValue.getDate())) {
                    ageAtReg--;
                }
                
                if (ageAtReg >= 24 && yorValue <= new Date()) {
                    dob.classList.add('valid');
                    dob.classList.remove('invalid');
                    yor.classList.add('valid');
                    yor.classList.remove('invalid');
                    dob.setCustomValidity('');
                    yor.setCustomValidity('');
                } else {
                    dob.classList.add('invalid');
                    dob.classList.remove('valid');
                    yor.classList.add('invalid');
                    yor.classList.remove('valid');
                    
                    if (ageAtReg < 24) {
                        dob.setCustomValidity('You should be at least 24 years old when registering');
                        yor.setCustomValidity('');
                    } else {
                        dob.setCustomValidity('');
                        yor.setCustomValidity('Registration year cannot be in the future');
                    }
                }
            }
        };
        
        dob.addEventListener('input', validateDates);
        yor.addEventListener('input', validateDates);
    }

    function calculatePasswordStrength(password) {
        let score = 0;
        
        // Length check
        if (password.length >= 8) score++;
        if (password.length >= 12) score++;
        
        // Character type checks
        if (/[a-z]/.test(password)) score++;
        if (/[A-Z]/.test(password)) score++;
        if (/\d/.test(password)) score++;
        if (/[!@#$%^&*()_+\-=\[\]{};:'"\\|,.<>\/?]/.test(password)) score++;
        
        // Penalties for weak patterns
        if (/(.)\1{2,}/.test(password)) score -= 1;
        if (/(0123|1234|2345|4567|5678|6789)/.test(password)) score -= 1;
        if (/(password|qwerty|admin|user)/i.test(password)) score -= 2;
        
        return Math.max(0, score);
    }
    
    function updateStrengthIndicator(strength) {
        let className, text;
        
        if (strength <= 2) {
            className = 'weak';
            text = 'Weak';
        } else if (strength <= 4) {
            className = 'fair';
            text = 'Fair';
        } else if (strength <= 6) {
            className = 'good';
            text = 'Good';
        } else {
            className = 'strong';
            text = 'Strong';
        }
        
        strengthFill.className = `strength-fill ${className}`;
        strengthLabel.textContent = text;
    }
});
</script>

{% endblock %}
